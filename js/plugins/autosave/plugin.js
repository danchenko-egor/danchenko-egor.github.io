(function(){"use strict";var t=tinymce.util.Tools.resolve("tinymce.PluginManager");const e=(t,e,r)=>{var o;return!!r(t,e.prototype)||(null===(o=t.constructor)||void 0===o?void 0:o.name)===e.name},r=t=>{const r=typeof t;return null===t?"null":"object"===r&&Array.isArray(t)?"array":"object"===r&&e(t,String,((t,e)=>e.isPrototypeOf(t)))?"string":r},o=t=>e=>r(e)===t,a=t=>e=>t===e,s=o("string"),n=a(void 0);var i=tinymce.util.Tools.resolve("tinymce.util.Delay"),u=tinymce.util.Tools.resolve("tinymce.util.LocalStorage"),l=tinymce.util.Tools.resolve("tinymce.util.Tools");const c=t=>t.dispatch("RestoreDraft"),m=t=>t.dispatch("StoreDraft"),d=t=>t.dispatch("RemoveDraft"),v=t=>{const e={s:1e3,m:6e4},r=/^(\d+)([ms]?)$/.exec(t);return(r&&r[2]?e[r[2]]:1)*parseInt(t,10)},f=t=>e=>e.options.get(t),p=t=>{const e=t.options.register,r=t=>{const e=s(t);return e?{value:v(t),valid:e}:{valid:!1,message:"Must be a string."}};e("autosave_ask_before_unload",{processor:"boolean",default:!0}),e("autosave_prefix",{processor:"string",default:"tinymce-autosave-{path}{query}{hash}-{id}-"}),e("autosave_restore_when_empty",{processor:"boolean",default:!1}),e("autosave_interval",{processor:r,default:"30s"}),e("autosave_retention",{processor:r,default:"20m"})},g=f("autosave_ask_before_unload"),y=f("autosave_restore_when_empty"),D=f("autosave_interval"),h=f("autosave_retention"),_=t=>{const e=document.location;return t.options.get("autosave_prefix").replace(/{path}/g,e.pathname).replace(/{query}/g,e.search).replace(/{hash}/g,e.hash).replace(/{id}/g,t.id)},I=(t,e)=>{if(n(e))return t.dom.isEmpty(t.getBody());{const r=l.trim(e);if(""===r)return!0;{const e=(new DOMParser).parseFromString(r,"text/html");return t.dom.isEmpty(e)}}},b=t=>{var e;const r=parseInt(null!==(e=u.getItem(_(t)+"time"))&&void 0!==e?e:"0",10)||0;return!((new Date).getTime()-r>h(t))||(w(t,!1),!1)},w=(t,e)=>{const r=_(t);u.removeItem(r+"draft"),u.removeItem(r+"time"),!1!==e&&d(t)},S=t=>{const e=_(t);!I(t)&&t.isDirty()&&(u.setItem(e+"draft",t.getContent({format:"raw",no_events:!0})),u.setItem(e+"time",(new Date).getTime().toString()),m(t))},E=t=>{var e;const r=_(t);b(t)&&(t.setContent(null!==(e=u.getItem(r+"draft"))&&void 0!==e?e:"",{format:"raw"}),c(t))},R=t=>{const e=D(t);i.setEditorInterval(t,(()=>{S(t)}),e)},T=t=>{t.undoManager.transact((()=>{E(t),w(t)})),t.focus()},M=t=>({hasDraft:()=>b(t),storeDraft:()=>S(t),restoreDraft:()=>E(t),removeDraft:e=>w(t,e),isEmpty:e=>I(t,e)});var x=tinymce.util.Tools.resolve("tinymce.EditorManager");const A=t=>{t.editorManager.on("BeforeUnload",(t=>{let e;l.each(x.get(),(t=>{t.plugins.autosave&&t.plugins.autosave.storeDraft(),!e&&t.isDirty()&&g(t)&&(e=t.translate("You have unsaved changes are you sure you want to navigate away?"))})),e&&(t.preventDefault(),t.returnValue=e)}))},B=t=>e=>{e.setEnabled(b(t));const r=()=>e.setEnabled(b(t));return t.on("StoreDraft RestoreDraft RemoveDraft",r),()=>t.off("StoreDraft RestoreDraft RemoveDraft",r)},P=t=>{R(t);const e=()=>{T(t)};t.ui.registry.addButton("restoredraft",{tooltip:"Restore last draft",icon:"restore-draft",onAction:e,onSetup:B(t)}),t.ui.registry.addMenuItem("restoredraft",{text:"Restore last draft",icon:"restore-draft",onAction:e,onSetup:B(t)})};var j=()=>{t.add("autosave",(t=>(p(t),A(t),P(t),t.on("init",(()=>{y(t)&&t.dom.isEmpty(t.getBody())&&E(t)})),M(t))))};j()})();